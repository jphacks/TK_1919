<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="video.css">
    <title>旅行レコメンドサービス</title>   
</head>
<body>
        <div class="topMenu">
            <div class="topMenu__title">旅行レコメンドサービス</div>
            <div class="topMenu__register">会員登録</div>
            <div class="topMenu__register">履歴を見る</div>
            <div class="topMenu__register">旅行会社一覧</div>
        </div>
        <div class="maincontents">
            <h2 class="maincontents__which">Which do you like?</h2>
            <div class="maincontents__images">
                    <img class="leftimage" src="hackpicture/1a.jpg">
                    <img class="rightimage" src="hackpicture/1b.jpg">
            </div>          
            <canvas id="canvas" style="display:none"></canvas>
            <video id="video" autoplay></video>
        </div>
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>

            $(function() {
                var video = document.getElementById('video');
                var onFailSoHard = function(e) {
                    console.log('エラー!');
                };
     
                window.URL = window.URL || window.webkitURL;
                navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                navigator.getUserMedia({video: true}, function(stream) {
                    video.srcObject = stream;
                }, onFailSoHard);

                //左だったら+1をして 右だったら0にしよう　3 2 1 0の４段階である
                var resultRawArray = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                var resultArray = [0,0,0,0,0]
                var magicNumber = 29
                var requestCount = 0

                var calculate = function() {
                    for (var i = 0;i < 5; i++) {
                    resultArray[i] = resultRawArray[i*3] + resultRawArray[i*3 + 1] + resultRawArray[i*3 + 2]
                    }
                    console.log(resultRawArray)
                    console.log(resultArray)
                }
            
                var count = 0;
                var sendPicture = function() {
                        if(count % 10 == 0) {
                                const leftsrc = "hackpicture/" + (count / 10 + 1) + "a.jpg"
                                const rightsrc = "hackpicture/" + (count / 10 + 1) + "b.jpg"
                                document.querySelectorAll('.leftimage')[0].src = leftsrc
                                document.querySelectorAll('.rightimage')[0].src = rightsrc
                            
                        }

                        var canvas = document.getElementById('canvas');
                        var ctx = canvas.getContext('2d');
                        var img = document.getElementById('img');

                        var w = video.offsetWidth;
                        var h = video.offsetHeight;

                        canvas.setAttribute("width", w);
                        canvas.setAttribute("height", h);

                        ctx.drawImage(video, 0, 0, w, h);                 

                        const src = canvas.toDataURL('image/png');

                        var url = ' https://gkjpi8czp3.execute-api.us-east-2.amazonaws.com/dev/image'

                        const reqPara = {
                            "b64" : src.slice(22),
                            "pictureNumber": Math.floor(count / 10 + 1),
                            "tryNumber": count % 10  //7か８か９がはいる
                        }

                        var request = new XMLHttpRequest();
                        request.open('POST', url);
                        request.responseType = 'application/json'; 
                        request.onload = function () {
                            console.log("success");
                            requestCount++
                            
                            if (JSON.parse(request.response).body[0][0]) {
                                if (JSON.parse(request.response).body[0][0]['gaze'][0] < 0) {
                                    console.log("右")
                                }
                                else {
                                    const pictureNumber = JSON.parse(request.response).body[1]
                                    console.log(pictureNumber)//1か2か３が入る
                                    resultRawArray[pictureNumber - 1] = 1
                                    console.log("左")
                                }
                            }
                            else {
                                document.querySelectorAll('.result')[0].innerText = "読み取れませんでした"
                                console.log("再送")
                            }

                            if (requestCount == (magicNumber + 1) * 3 / 10) {
                                //最後の判定
                                console.log("最後だよ")
                                 // 計算してあとはPythonに任せよう
                                calculate()
                            }

                        };
                        request.onerror = function(error) {
                            alert(JSON.stringify(error));
                            requestCount++
                        }
                        
                        request.setRequestHeader('Content-Type', 'application/json'); 
                        //0.7 0.8 0.9 1.7 1.8 1.9 2.7 2.8 2.9秒に実行するための処理
                        if (count % 10 < 7) {
                        }
                        else {
                            request.send(JSON.stringify(reqPara));               
                        }
                        var timeout = setTimeout(sendPicture, 100);
                        count++
                        if(count > magicNumber) {　
                            //149にするとちょうどいい
                            clearTimeout(timeout);　//idをclearTimeoutで指定している
                        }

                };

                sendPicture();

            
                });

        </script>
</body>
</html>