<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" type="text/css" href="video.css">
    <title>旅行レコメンドサービス</title>   
</head>
<body>
        <div class="topMenu">
            <div class="topMenu__title">旅行レコメンドサービス</div>
            <div class="topMenu__register">会員登録</div>
            <div class="topMenu__register">履歴を見る</div>
            <div class="topMenu__register">おすすめ旅行会社</div>
        </div>
        <div class="maincontents">
            <h2 class="maincontents__which">Which do you like?</h2>
            <div class="maincontents__images">
                    <img class="leftimage" src="kappa.jpeg">
                    <img class="rightimage" src="kappa.jpeg">
            </div>   
            <button id="start">start</button>
            <h2 class="result">ここに結果が表示される</h2>
            <canvas id="canvas" style="display:none"></canvas>
            <video id="video" autoplay></video>
        </div>
        
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
        <script>

            $(function() {
                var video = document.getElementById('video');
                var onFailSoHard = function(e) {
                    console.log('エラー!');
                };
     
                window.URL = window.URL || window.webkitURL;
                navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
                navigator.getUserMedia({video: true}, function(stream) {
                    video.srcObject = stream;
                }, onFailSoHard);

                //左だったら+1をして右だったら-1をするという風にしよう
                var resultRawArray = [[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]]
                var resultArray = [0,0,0,0,0]
            
                var count = 0;
                var sendPicture = function() {
                        if(count % 10 == 0) {
                            if (count % 20 == 0) {
                                document.querySelectorAll('.leftimage')[0].src = "kappa.jpeg"
                                document.querySelectorAll('.rightimage')[0].src = "kappa.jpeg"
                            }
                            else {
                                document.querySelectorAll('.leftimage')[0].src = "kappa2.jpeg"
                                document.querySelectorAll('.rightimage')[0].src = "kappa2.jpeg"
                            }
                        }

                        var canvas = document.getElementById('canvas');
                        var ctx = canvas.getContext('2d');
                        var img = document.getElementById('img');

                        var w = video.offsetWidth;
                        var h = video.offsetHeight;

                        canvas.setAttribute("width", w);
                        canvas.setAttribute("height", h);

                        ctx.drawImage(video, 0, 0, w, h);                 

                        const src = canvas.toDataURL('image/png');

                        var url = ' https://gkjpi8czp3.execute-api.us-east-2.amazonaws.com/dev/image'

                        const reqPara = {
                            "b64" : src.slice(22),
                            "pictureNumber": count / 10 + 1,
                            "tryNumber": count % 10
                        }

                        var request = new XMLHttpRequest();
                        request.open('POST', url);
                        request.responseType = 'application/json'; 
                        request.onload = function () {
                            console.log("success");
                            console.log(JSON.parse(request.response).body)

                            if (JSON.parse(request.response).body[0]) {
                                if (JSON.parse(request.response).body[0]['gaze'][0] < 0) {
                                    document.querySelectorAll('.result')[0].innerText = "あなたは右を向いている"
                                    console.log("右")
                                }
                                else {
                                    document.querySelectorAll('.result')[0].innerText = "あなたは左を向いている"
                                    console.log("左")
                                }
                            }
                            else {
                                document.querySelectorAll('.result')[0].innerText = "読み取れませんでした"
                                console.log("再送")

                            }
                        };
                        request.onerror = function(error) {
                            alert(JSON.stringify(error));
                        }
                        
                        request.setRequestHeader('Content-Type', 'application/json'); 
                        //0.7 0.8 0.9 1.7 1.8 1.9 2.7 2.8 2.9秒に実行するための処理
                        if (count % 10 < 7) {
                            console.log("定期処理が却下された");
                        }
                        else {
                            // request.send(JSON.stringify(reqPara));
                            console.log("定期処理が実行された");
                        }
                        var timeout = setTimeout(sendPicture, 100);
                        count++
                        if(count > 5000) {　
                            clearTimeout(timeout);　//idをclearTimeoutで指定している
                        }

                };

                sendPicture();


                });

        </script>
</body>
</html>